<!DOCTYPE html>

<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Chango&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>topoMap</title>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCxmwq7svGGXSeaXHsxfW27LDaXytc3nBY&sensor=false&libraries=panoramio,geometry"></script>
    <style>
      * {
        margin: 0px;
      }
      body {
        font-family: sans-serif;
        margin: 0px 0px 0px 2px;
      }
      H1 {

      }

      #map_canvas {
        margin: 0px;
        width: 100%;
        border: 1px solid black;
        height: 400px
      }
      #tools_div {
        width: 100%;
        font-size: small;
        text-align: justify;
      }
      #tools_div span {
        display: inline-block;
      }
      #tools_div:after {
        content: '';
        width: 100%;
        display: inline-block;
      }

      #chart_div {
        float: left;
        width: 70%;
        height: 200px;
      }
      #text_div {
        float: right;
        width: 30%;
        height: 200px
      }
      #bottom-text {
        float: left;
        width: 70%;
      }
      .logo {
        font-family: 'Chango', sans-serif;
      }

      #splash {
        z-index: 1;
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: rgb(156,156,156);
      }
      #splash div {
        z-index: 2;
        margin: 40px;
        border-radius: 10px 10px 10px 10px;
        border-style: solid;
        border-width: 2px;
        background-color: rgb(0, 135, 255);
        border-color: rgb(50, 50, 50);
        text-align: center
      }
      #splash div h1 {
        font-size: 30pt;
        text-shadow: 2px 2px 10px white;
        margin-top: 0;
        margin-bottom: 0
      }
      #splash div p {
        margin-top: 0;
        margin-bottom: 10px
      }
      #acknowledgement {
        width: 450px;
        position: relative;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        bottom: 0px;
        font-family: serif;
        font-size: 10pt;
        color: rgb(100, 100, 100);
      }
      #instructions {
        z-index: 1;
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: rgb(156,156,156);
      }
      #instructions div {
        z-index: 2;
        margin: 40px;
        /*height: 350px;
         width: 500px;*/
        border-radius: 10px 10px 10px 10px;
        border-style: solid;
        border-width: 2px;
        background-color: rgb(0, 135, 255);
        border-color: rgb(50, 50, 50);
        text-align: center;
      }

      #instructions div ul {
        text-align: left
      }

      .five {
        float: left;
        width: 18%;
        text-align: center;
        margin: 2px 2% 2px 0;
      }

      .fivelast {
        float: right;
        width: 18%;
        text-align: center;
        margin: 2px 0 2px 0;
      }

    </style>
    <script type="text/javascript">
      //Marty's UI
      function update(element, pasteObject) {
        element.textContent = pasteObject;
      }

      function get(id) {
        return document.getElementById(id);
      }

      function show(elname) {
        console.log("show: " + elname);
        var element = document.getElementById(elname);
        element.style.display = 'block';
      }

      function hide(elname) {
        console.log("hide: " + elname);
        var element = document.getElementById(elname);
        element.style.display = 'none';
      }

      function toggleshow(elname) {
        console.log("showtoggle: " + elname);
        var element = document.getElementById(elname);
        if (element.style.display == 'block') {
          element.style.display = 'none';
        } else {
          element.style.display = 'block';
        };
      }
    </script>

    <script type="text/javascript">
      var w = window, d = document, e = d.documentElement, g = d.getElementsByTagName('body')[0], width = w.innerWidth || e.clientWidth || g.clientWidth, height = w.innerHeight || e.clientHeight || g.clientHeight;

      var map = null;
      var panoramioLayer = new google.maps.panoramio.PanoramioLayer();
      var chart = null;
      var totLen = null;
      var totArea = null;

      var geocoderService = null;
      var elevationService = null;
      var directionsService = null;

      var mousemarker = null;
      var markers = [];
      var polyline = null;
      var polyline2 = null;
      var elevations = null;
      var pathLength = null;
      //use for length of latlngs: []

      var SAMPLES = 256;
    </script>
    <script>
var examples = [{
// Lombard St
latlngs: [
  [37.801000, -122.426499],
  [37.802051, -122.419418],
  [37.802729, -122.413989]
],
mapType: google.maps.MapTypeId.TERRAIN,
travelMode: 'direct'
},{
//Waipio, HI
latlngs: [
  [20.117386,-155.57941],
  [20.1000,-155.58000],
  [20.200668,-155.741158]
],
mapType: google.maps.MapTypeId.TERRAIN,
travelMode: 'direct'
},{
// Mount Everest
latlngs: [
[27.973323, 86.908035],
[28.020614, 86.960906]
],
mapType: google.maps.MapTypeId.TERRAIN,
travelMode: 'direct'
},{
// Challenger Deep
latlngs: [
[9.764009, 143.076632],
[11.932658, 142.373507]
],
mapType: google.maps.MapTypeId.SATELLITE,
travelMode: 'direct'
},{
// Death Valley
latlngs: [
[37.040952, -117.300314],
[35.896862, -116.654868],
[35.972751, -116.270689]
],
mapType: google.maps.MapTypeId.TERRAIN,
travelMode: 'direct'
},{
// Grand Canyon
latlngs: [
[36.012196, -112.100348],
[36.221866, -112.098975],
],
mapType: google.maps.MapTypeId.TERRAIN,
travelMode: 'direct'
},{
// Uluru
latlngs: [
[-25.34696, 131.022323],
[-25.34060, 131.045927]
],
mapType: google.maps.MapTypeId.SATELLITE,
travelMode: 'direct'
}];
    </script>
    <script>
      // Load the Visualization API and the columnchart package.
      //google.load("visualization", "1", {packages: ["columnchart"]});
      google.load("visualization", "1", {
        packages : ["scatterchart"]
      });

      // Set a callback to run when the Google Visualization API is loaded.
      google.setOnLoadCallback(initialize);

      function initialize() {
        var myLatlng = new google.maps.LatLng(15, 0);
        var myOptions = {
          zoom : 1,
          center : myLatlng,
          mapTypeId : google.maps.MapTypeId.TERRAIN,
          scaleControl : true
        };

        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        //chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));

        geocoderService = new google.maps.Geocoder();
        elevationService = new google.maps.ElevationService();
        directionsService = new google.maps.DirectionsService();

        google.maps.event.addListener(map, 'click', function(event) {
          addMarker(event.latLng, true);
        });

        google.visualization.events.addListener(chart, 'onmouseover', function(e) {
          if (mousemarker == null) {
            mousemarker = new google.maps.Marker({
              position : elevations[e.row].location,
              map : map,
              icon : "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
            });
          } else {
            mousemarker.setPosition(elevations[e.row].location);
          }
        });

        loadExample(0);
      }
    </script>
    <script>
      function plotElevation(results) {
        // Takes an array of ElevationResult objects, draws the path on the map
        // and plots the elevation profile on a GViz ColumnChart
        elevations = results;
        var path = [];
        for (var i = 0; i < results.length; i++) {
          path.push(elevations[i].location);
        };

        if (polyline) {
          polyline.setMap(null);
        };
        if (polyline2) {
          polyline2.setMap(null);
        };

        polyline = new google.maps.Polyline({
          path : path,
          strokeColor : "#000000",
          strokeWeight : 3,
          zIndex : 1,
          map : map
        });

        polyline2 = new google.maps.Polyline({
          path : [path[0], path[path.length - 1]], //change path to just connect the first point and the last point.
          strokeColor : "#ff6f2d",
          strokeOpacity : 0,
          zIndex : 0,
          icons : [{
            icon : {
              path : 'M 0,-0.5 0,0.5',
              strokeOpacity : 1,
              strokeWeight : 6,
              scale : 1
            },
            offset : '100%',
            repeat : '12px'
          }],
          map : map
        });
        updateText(path, elevations);

        var data = new google.visualization.DataTable();
        //data.addColumn('string', 'Sample'); //original
        data.addColumn('number', 'Distance');
        //for scatterchart
        data.addColumn('number', 'Elevation');
        var pathLength2 = google.maps.geometry.spherical.computeLength(path).toFixed(0);
        //calculating again!
        var dist = pathLength2 / SAMPLES;
        //to calculate distance along path, find path length / number of samples -1.
        var distance = 0;
        //console.log("New dist: " + dist);
        for (var i = 0; i < results.length; i++) {
          distance = dist * i;
          //data.addRow(['', elevations[i].elevation]);//original;
          data.addRow([distance, elevations[i].elevation]);
          //for scatterchart
        };

        document.getElementById('chart_div').style.display = 'block';
        var chartwidth = width * 0.7;
        chart.draw(data, {
          width : chartwidth, //Chart width 600
          height : 200,

          //pointSize: 1,
          legend : 'none',
          titleY : 'Elevation (m)',
          titleX : 'Distance (m)',
          //focusBorderColor: '#00ff00',//green, to match the moving map marker.  ?!?!this option isn't listed in the API.
          focusBorderColor : {
            'stroke' : '#00ff00',
            'strokeSize' : 10
          },
          pointSize : 4, //ignored
          lineWidth : 1 //sigh. ignored.
          //hAxis: {title: 'distance', minValue:0, maxValue: 100},//This stuff just gets ignored!!!
          //vAxis: {title: 'Elevation'}//ignored!!?!!        });
          //console.log(data);
        });
      }

      // Remove the green rollover marker when the mouse leaves the chart
      function clearMouseMarker() {
        if (mousemarker != null) {
          mousemarker.setMap(null);
          mousemarker = null;
        };
      }

      // Geocode an address and add a marker for the result
      function addAddress() {
        var address = document.getElementById('address').value;
        geocoderService.geocode({
          'address' : address
        }, function(results, status) {
          document.getElementById('address').value = "";
          if (status == google.maps.GeocoderStatus.OK) {
            var latlng = results[0].geometry.location;
            addMarker(latlng, true);
            if (markers.length > 1) {
              var bounds = new google.maps.LatLngBounds();
              for (var i in markers) {
                bounds.extend(markers[i].getPosition());
              }
              map.fitBounds(bounds);
            } else {
              map.fitBounds(results[0].geometry.viewport);
            };
          } else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
            alert("Address not found");
          } else {
            alert("Address lookup failed");
          }
          ;
        });
      }

      // Add a marker and trigger recalculation of the path and elevation
      function addMarker(latlng, doQuery) {
        var maxLength = 150;
        if (markers.length < maxLength) {//Do I want to limit the number of points??

          var marker = new google.maps.Marker({
            position : latlng,
            map : map,
            draggable : true
          });

          google.maps.event.addListener(marker, 'dragend', function(e) {
            updateElevation();
          });

          markers.push(marker);

          if (doQuery) {
            updateElevation();
          };

          if (markers.length == maxLength) {
            document.getElementById('address').disabled = true;
          };
        } else {
          alert("No more than " + maxLength + " points can be added");
        };
      }

      // Trigger the elevation query for point to point
      // or submit a directions request for the path between points
      function updateElevation() {
        if (markers.length > 1) {
          var travelMode = 'direct';
          if (travelMode != 'direct') {//I disabled the other travelmodes.
            calcRoute(travelMode);
          } else {
            var latlngs = [];
            for (var i in markers) {
              latlngs.push(markers[i].getPosition());
            };

            elevationService.getElevationAlongPath({
              path : latlngs,
              samples : SAMPLES
            }, plotElevation);
            //updateText(latlngs);//new plan: call from within plotElevation so that I can use the array of elevations.
          };
        };
      }

      function updateText(path, elevs) {
        var textDiv = document.getElementById('text_div');
        textDiv.style.display = 'block';

        var pathLength = google.maps.geometry.spherical.computeLength(path).toFixed(0);
        var directLength = google.maps.geometry.spherical.computeDistanceBetween(path[0], path[path.length - 1]).toFixed(0);
        var closedLength = +pathLength + +directLength;
        //convert to number
        var pathArea = google.maps.geometry.spherical.computeArea(path).toFixed(0);
        var startElev = elevs[0].elevation.toFixed(0);
        var endElev = elevs[elevs.length - 1].elevation.toFixed(0);
        var relief = startElev - endElev;
        var pathSlope = relief / pathLength;
        var directSlope = relief / directLength;
        var sinuosity = pathLength / directLength;
        var longString = //This would be easier with Handlebars or such...
        "<h3>Path Information</h3><p>" + "<abbr title='the distance along the black line'>Path length</abbr>: " + pathLength + " meters<br>" + "<abbr title='the distance along the dotted orange line'>Direct length</abbr>: " + directLength + " meters<br>" + "<abbr title='the distance along the perimeter of the enclosed area'>Closed path length</abbr>: " + closedLength + " m<br><br>" + "<abbr title='the area inside the black and orange lines.'>Area</abbr>: " + pathArea + " sq. meters<br><br>" + "<abbr title='the height above sea level for the first point'>Start elevation</abbr>: " + startElev + " meters A.M.S.L<br>" + "<abbr title='the height above sea level for the last point'>End elevation</abbr>: " + endElev + " meters A.M.S.L<br>" + "<abbr title='the difference in height between the first point and the last point'>Relief</abbr>: " + relief + " meters<br><br>" + "<abbr title='the difference in height between the first point and the last point, divided by the length of the black line'>Path slope</abbr>: " + pathSlope.toFixed(4) + "<br>" + "<abbr title='the difference in height between the first point and the last point, divided by the length of the dotted orange line'>Direct slope</abbr>: " + directSlope.toFixed(4) + "<br><br>" + "<abbr title='the length of the black line divided by the length of the dotted orange line'>Sinuosity</abbr>: " + sinuosity.toFixed(2) + "</p>";
        update(get("pathLength"), pathLength);
        update(get("directLength"), directLength);
        update(get("closedLength"), closedLength);
        update(get("pathArea"), pathArea);
        update(get("startElev"), startElev);
        update(get("endElev"), endElev);
        update(get("relief"), relief);
        update(get("pathSlope"), pathSlope.toFixed(4));
        update(get("directSlope"), directSlope.toFixed(4));
        update(get("sinuosity"), sinuosity.toFixed(2));

        //textDiv.innerHTML = longString;
      }

      // Submit a directions request for the path between points and an
      // elevation request for the path once returned
      function calcRoute(travelMode) {
        var origin = markers[0].getPosition();
        var destination = markers[markers.length - 1].getPosition();

        var waypoints = [];
        for (var i = 1; i < markers.length - 1; i++) {
          waypoints.push({
            location : markers[i].getPosition(),
            stopover : true
          });
        };

        var request = {
          origin : origin,
          destination : destination,
          waypoints : waypoints
        };

        switch (travelMode) {
          case "bicycling":
            request.travelMode = google.maps.DirectionsTravelMode.BICYCLING;
            break;
          case "driving":
            request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
            break;
          case "walking":
            request.travelMode = google.maps.DirectionsTravelMode.WALKING;
            break;
        };

        directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            elevationService.getElevationAlongPath({
              path : response.routes[0].overview_path,
              samples : SAMPLES
            }, plotElevation);
          } else if (status == google.maps.DirectionsStatus.ZERO_RESULTS) {
            alert("Could not find a route between these points");
          } else if (status == google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
            alert("This webpage has reached is query limit. Too many elevation requests have been made today.");
          } else {
            alert("Directions request failed");
          }
          ;
        });
      }

      // Trigger a geocode request when the Return key is
      // pressed in the address field
      function addressKeyHandler(e) {
        var keycode;
        if (window.event) {
          keycode = window.event.keyCode;
        } else if (e) {
          keycode = e.which;
        } else {
          return true;
        }
        ;

        if (keycode == 13) {
          addAddress();
          return false;
        } else {
          return true;
        };
      }

      function loadExample(n) {
        reset();
        map.setMapTypeId(examples[n].mapType);
        //document.getElementById('mode').value = examples[n].travelMode;
        var bounds = new google.maps.LatLngBounds();
        for (var i = 0; i < examples[n].latlngs.length; i++) {
          var latlng = new google.maps.LatLng(examples[n].latlngs[i][0], examples[n].latlngs[i][1]);
          addMarker(latlng, false);
          bounds.extend(latlng);
        };
        map.fitBounds(bounds);
        updateElevation();
      }

      // Clear all overlays, reset the array of points, and hide the chart
      function reset() {
        if (polyline) {
          polyline.setMap(null);
        };

        if (polyline2) {
          polyline2.setMap(null);
        };

        for (var i in markers) {
          markers[i].setMap(null);
        };

        markers = [];

        document.getElementById('chart_div').style.display = 'none';
        document.getElementById('text_div').style.display = 'none';
      }

      function photoToggle() {
        var showphoto = document.getElementById('photos');
        if (showphoto.checked) {
          panoramioLayer.setMap(map);
        } else {
          panoramioLayer.setMap(null);
        };
      }

    </script>

  </head>
  <body>
    <div id="splash">
      <div>
        <h1 class="logo">topoMap</h1>
        <h5>tools for measuring the Earth</h5>
        <p>
          Use these tools to measure the size and shape of geomorphic landforms.
        </p>
        <p>
          <b>Instructions:</b> Use the map to find interesting landforms.
          Click on the map to add markers. The graph will show the topographic
          profile of the line that you trace. The 'Path Information' window
          will tell you the length of the black and orange lines, the area
          of the region that they enclose, and the slope of the two lines.
          By tracing along meandering streams, you can measure the sinuosity
          of the stream.
        </p>
        <p>
          Let me know if you have any comments or suggestions!
        </p>
        <p>
          -Marty
        </p>
        <button onclick="hide('splash')">
          OK
        </button>

        <p id="acknowledgement">
          topoMap &copy; 2013 Martin Roberge
        </p>

      </div>
    </div>
    <div id="instructions" style="display:none">
      <div>
        <h1 class="logo">topoMap</h1>
        <h5>tools for measuring the Earth</h5>
        <ul>
          <li>
            Click on the map to draw new points
          </li>
          <li>
            Click on the 'show photos' checkbox to show ground photos
          </li>
          <li>
            The topographic profile of the black path is plotted at the bottom of the page.
          </li>
          <li>
            Distance, area, and slope are displayed at the bottom right of the page.
          </li>
          <li>
            Area is calculated for the polygon enclosed by the dotted line.
          </li>
          <li>
            Place your cursor over the profile graph to see your position on the map.
          </li>
          <li>
            Click on the graph to show the distance along the profile and the elevation of the point.
          </li>
        </ul>
        <p>
          Leave a note on the <a href="https://github.com/mroberge/topomap/">project page</a> if you have any suggestions for improvements!
        </p>
        <p>
          -Marty
        </p>
        <button onclick="hide('instructions')">
          OK
        </button>
      </div>
    </div>
    <h1 class="logo">topoMap</h1>
    <h5>tools for measuring the Earth</h5>
    <div id="map_canvas" >
      map
    </div>
    <div id="tools_div">

      <span><a href="#" onclick="show('instructions'); return false">Instructions</a></span>
      <span>
        <input id="photos" type="checkbox" onclick="photoToggle()">
        show photos</span>
      <span>
        <select name="selectPlace" id="selectPlace" onchange="loadExample(value)">
          <option value="default" disabled="disabled" selected="selected" style="display:none">Profile of an interesting place</option>
          <option value="1" >Waipio Valley</option>
          <option value="2" >Mount Everest</option>
          <option value="3">Challenger Deep</option>
          <option value="4">Death Valley</option>
          <option value="5">Grand Canyon</option>
          <option value="6">Uluru</option>
        </select></span>
      <span>Address:
        <input type="text" id="address" size="15" onkeypress="return addressKeyHandler(event)"/>
      </span>
      <span>
        <input type="button" value="Clear points" onclick="reset()"/>
      </span>

    </div>

    <div id="chart_div"  onmouseout="clearMouseMarker()">
      chart
    </div>

    <div id="text_div">
      <h3>Path Information</h3>
      <div>
        <abbr title='the distance along the black line'>Path length</abbr>: <span id="pathLength">1</span> meters
      </div>
      <div>
        <abbr title='the distance along the dotted orange line'>Direct length</abbr>: <span id= "directLength">2</span> meters
      </div>
      <div>
        <abbr title='the distance along the perimeter of the enclosed area'>Closed path length</abbr>: <span id="closedLength">3</span> m
        <br>
      </div>
      <div>
        <abbr title='the area inside the black and orange lines.'>Area</abbr>: <span id="pathArea">4</span> sq. meters
        <br>
      </div>
      <div>
        <abbr title='the height above sea level for the first point'>Start elevation</abbr>: <span id="startElev">5</span> meters A.M.S.L
      </div>
      <div>
        <abbr title='the height above sea level for the last point'>End elevation</abbr>: <span id="endElev">6</span> meters A.M.S.L
      </div>
      <div>
        <abbr title='the difference in height between the first point and the last point'>Relief</abbr>: <span id="relief">7</span> meters
        <br>
      </div>
      <div>
        <abbr title='the difference in height between the first point and the last point, divided by the length of the black line'>Path slope</abbr>: <span id="pathSlope">8.0001</span>
      </div>
      <div>
        <abbr title='the difference in height between the first point and the last point, divided by the length of the dotted orange line'>Direct slope</abbr>: <span id= "directSlope">9.0001</span>
        <br>
      </div>
      <div>
        <abbr title='the length of the black line divided by the length of the dotted orange line'>Sinuosity</abbr>: <span id="sinuosity">10.01</span>
      </div>
    </div>

    <div id="bottom-text">
      <p>
        <strong>Warning:</strong> I've had difficulties using this page in Internet Explorer. If it doesn't work, try using FireFox or Chrome!
      </p>
      <ul>
        <li>
          Add points by clicking on the map or entering an address
        </li>
        <li>
          Hover over the graph to see the map position of the cursor.
        </li>
        <li>
          Click on the graph to find the distance and height of the point.
        </li>
        <li>
          <a href="#" onclick="show('instructions'); return false">More instructions</a>
        </li>
        <li>
          Visit the <a href="https://github.com/mroberge/topomap/">topoMap repository</a> on GitHub!
        </li>
      </ul>
    </div>
  </body>
</html>
